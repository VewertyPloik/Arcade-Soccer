<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arcade Soccer</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden; touch-action: none;
    background: green;
    font-family: Arial, sans-serif;
    height: 100%;
  }
  #gameCanvas {
    display: block;
    background: #4CAF50;
  }
  #messageBox, #homeScreen {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    user-select: none;
    z-index: 20;
  }
  #homeScreen {
    width: 80vw;
    height: 80vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #homeScreen h1 {
    font-size: 3em;
    margin-bottom: 40px;
  }
  #homeScreen button {
    font-size: 24px;
    padding: 15px 40px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background: white;
    color: black;
    user-select: none;
  }
  #controls {
    position: absolute;
    bottom: 10px; left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 10px;
    z-index: 10;
  }
  .btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background: white;
    color: black;
    cursor: pointer;
    user-select: none;
  }
  #shootSliderContainer {
    position: absolute;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 30px;
    background: gray;
    border-radius: 15px;
    display: none;
    user-select: none;
  }
  #redZone {
    position: absolute;
    top: 0;
    height: 30px;
    background: red;
    border-radius: 15px;
    left: 40%;
    width: 20%;
  }
  #sliderArrow {
    position: absolute;
    top: -5px;
    width: 10px;
    height: 40px;
    background: yellow;
    border-radius: 3px;
    left: 0;
    transition: none;
  }
</style>
</head>
<body>
  <div id="homeScreen">
    <h1>Arcade Soccer</h1>
    <button id="playBtn">Play VS AI</button>
  </div>
  <canvas id="gameCanvas" style="display:none;"></canvas>

  <div id="messageBox" style="display:none;">
    <div id="resultText"></div>
  </div>

  <div id="controls" style="display:none;">
    <button id="stealBtn" class="btn">Steal</button>
    <button id="tackleBtn" class="btn">Tackle</button>
    <button id="shootBtn" class="btn">Shoot</button>
  </div>

  <div id="shootSliderContainer">
    <div id="redZone"></div>
    <div id="sliderArrow"></div>
  </div>

<script>
  const homeScreen = document.getElementById("homeScreen");
  const playBtn = document.getElementById("playBtn");
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const messageBox = document.getElementById("messageBox");
  const resultText = document.getElementById("resultText");

  const controls = document.getElementById("controls");
  const stealBtn = document.getElementById("stealBtn");
  const tackleBtn = document.getElementById("tackleBtn");
  const shootBtn = document.getElementById("shootBtn");

  const shootSliderContainer = document.getElementById("shootSliderContainer");
  const redZone = document.getElementById("redZone");
  const sliderArrow = document.getElementById("sliderArrow");

  let cw, ch;
  let baseSize;
  let playerSize, ballSize;

  // Entities
  let player, ai, ball;

  // Scores and timer
  let playerScore = 0;
  let aiScore = 0;
  const gameDuration = 60;
  let startTime;
  let gameOver = false;

  // Shoot slider
  let shootActive = false;
  let shootArrowPos = 0;
  let shootDirection = 1;
  let shootResultCallback = null;

  // Free kick state
  let freeKickFor = null; // 'player' or 'ai' or null

  // Player/AI speeds and flags
  const basePlayerSpeed = 0.08;
  const baseAISpeed = 0.18;

  // Shot animation
  let shotAnim = null;

  function init() {
    cw = window.innerWidth;
    ch = window.innerHeight;
    canvas.width = cw;
    canvas.height = ch;
    baseSize = Math.min(cw, ch);

    playerSize = baseSize * 0.05 * 3;
    ballSize = playerSize * 0.3;

    player = { x: cw * 0.1, y: ch / 2, size: playerSize, speed: basePlayerSpeed * 0.4, hasBall: false }; // Slower player
    ai = { x: cw * 0.9, y: ch / 2, size: playerSize, speed: baseAISpeed * 2.3, hasBall: false }; // Faster and aggressive AI
    ball = { x: cw / 2, y: ch / 2, size: ballSize, holder: null, dx: 0, dy: 0 };

    playerScore = 0;
    aiScore = 0;
    gameOver = false;
    freeKickFor = null;
    startTime = Date.now();

    messageBox.style.display = "none";
    controls.style.display = "flex";
    shootSliderContainer.style.display = "none";

    resetPositions();
    draw();
    update();
  }

  function resetPositions() {
    player.x = cw * 0.1;
    player.y = ch / 2;
    ai.x = cw * 0.9;
    ai.y = ch / 2;
    ball.x = cw / 2;
    ball.y = ch / 2;
    ball.dx = 0;
    ball.dy = 0;
    ball.holder = null;
    player.hasBall = false;
    ai.hasBall = false;
    freeKickFor = null;
    shotAnim = null;
  }

  function dist(a, b) {
    return Math.hypot(a.x - b.x, a.y - b.y);
  }

  function showMessage(msg) {
    resultText.textContent = msg;
    messageBox.style.display = "block";
    setTimeout(() => {
      messageBox.style.display = "none";
    }, 1500);
  }

  function drawEntity(entity, emoji) {
    ctx.font = `${entity.size}px serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(emoji, entity.x, entity.y);
    if (entity.hasBall) {
      // Draw ball at feet (slightly below center)
      ctx.font = `${ball.size}px serif`;
      ctx.fillText("⚽️", entity.x, entity.y + entity.size / 2.7);
    }
  }

  function drawGoals() {
    const goalWidth = 10;
    const goalHeight = ch * 0.2;
    ctx.fillStyle = "white";
    ctx.fillRect(0, ch / 2 - goalHeight / 2, goalWidth, goalHeight);
    ctx.fillRect(cw - goalWidth, ch / 2 - goalHeight / 2, goalWidth, goalHeight);
  }

  // Player movement by dragging
  canvas.addEventListener("touchmove", e => {
    if (gameOver || shootActive) return;
    const touch = e.touches[0];
    if (!touch) return;
    if (!player.hasBall) {
      let dx = (touch.clientX - player.x) * 0.2;
      let dy = (touch.clientY - player.y) * 0.2;
      player.x += dx * player.speed * 10; // Adjusted for slower speed
      player.y += dy * player.speed * 10;
    } else {
      player.x = touch.clientX;
      player.y = touch.clientY;
    }
    e.preventDefault();
  }, { passive: false });

  stealBtn.onclick = () => {
    if (ai.hasBall && !player.hasBall && !shootActive) {
      if (Math.random() < 0.1) {
        ai.hasBall = false;
        player.hasBall = true;
        ball.holder = "player";
        showMessage("Steal successful!");
      } else {
        showMessage("Steal failed!");
      }
    }
  };

  tackleBtn.onclick = () => {
    if (shootActive || gameOver) return;

    if (ai.hasBall && !player.hasBall) {
      freeKickFor = "player";
      showMessage("🟥 Free kick awarded to player ♦️");
      ai.hasBall = false;
      ball.holder = null;
    } else if (player.hasBall && !ai.hasBall) {
      freeKickFor = "ai";
      showMessage("🟥 Free kick awarded to AI ♦️");
      player.hasBall = false;
      ball.holder = null;
    }
  };

  shootBtn.onclick = () => {
    if ((player.hasBall || freeKickFor === "player") && !shootActive) {
      startShootSlider(success => {
        shootActive = false;
        shootSliderContainer.style.display = "none";

        let playerChance = success ? 0.35 : 0.10;

        if (freeKickFor === "player") {
          if (Math.random() < playerChance) {
            startShotAnimation("player", true);
          } else {
            startShotAnimation("player", false);
          }
          freeKickFor = null;
          player.hasBall = false;
          ball.holder = null;
          return;
        }

        if (Math.random() < playerChance) {
          startShotAnimation("player", true);
        } else {
          startShotAnimation("player", false);
        }
        player.hasBall = false;
        ball.holder = null;
      });
    }
  };

  function startShootSlider(callback) {
    shootActive = true;
    shootSliderContainer.style.display = "block";
    shootArrowPos = 0;
    shootDirection = 1;
    shootResultCallback = callback;

    function animate() {
      if (!shootActive) return;
      shootArrowPos += shootDirection * 5;
      if (shootArrowPos > 290) shootDirection = -1;
      else if (shootArrowPos < 0) shootDirection = 1;
      sliderArrow.style.left = shootArrowPos + "px";
      requestAnimationFrame(animate);
    }
    animate();
  }

  shootSliderContainer.addEventListener("click", () => {
    if (!shootActive) return;
    const redStart = shootSliderContainer.offsetWidth * 0.4;
    const redEnd = shootSliderContainer.offsetWidth * 0.6;
    const inRedZone = shootArrowPos >= redStart && shootArrowPos <= redEnd;
    shootActive = false;
    shootSliderContainer.style.display = "none";
    if (shootResultCallback) shootResultCallback(inRedZone);
  });

  // Shot animation handling
  function startShotAnimation(shooter, madeShot) {
    // Start ball traveling animation to goal or post
    let targetX, targetY;
    const goalHeight = ch * 0.2;
    if (shooter === "player") {
      targetX = cw - 10; // AI goal side
      if (madeShot) {
        targetY = ch / 2;
      } else {
        // Miss - side post: randomly top or bottom side post near goal
        targetY = (Math.random() < 0.5) ? ch / 2 - goalHeight / 2 + 15 : ch / 2 + goalHeight / 2 - 15;
      }
    } else {
      // AI shooting to player goal
      targetX = 10; // player goal side
      if (madeShot) {
        targetY = ch / 2;
      } else {
        targetY = (Math.random() < 0.5) ? ch / 2 - goalHeight / 2 + 15 : ch / 2 + goalHeight / 2 - 15;
      }
    }
    shotAnim = {
      x: ball.x,
      y: ball.y,
      targetX,
      targetY,
      progress: 0,
      duration: 30,
      shooter,
      madeShot,
    };

    // If made shot, increment score after animation finishes
    if (madeShot) {
      setTimeout(() => {
        if (shooter === "player") playerScore++;
        else aiScore++;
        showMessage(shooter === "player" ? "You scored!" : "AI scored!");
        resetPositions();
      }, shotAnim.duration * 16);
    } else {
      setTimeout(() => {
        showMessage(shooter === "player" ? "Shot missed!" : "AI missed!");
        // Leave ball at side post until someone picks it up
        ball.x = shotAnim.targetX;
        ball.y = shotAnim.targetY;
        ball.holder = null;
        resetPositionsAfterShotMiss();
      }, shotAnim.duration * 16);
    }
  }

  // Reset players after miss but ball stays on post (no possession)
  function resetPositionsAfterShotMiss() {
    player.x = cw * 0.1;
    player.y = ch / 2;
    ai.x = cw * 0.9;
    ai.y = ch / 2;
    player.hasBall = false;
    ai.hasBall = false;
  }

  function aiLogic() {
    if (gameOver || shootActive) return;
    if (freeKickFor === "ai") {
      setTimeout(() => {
        if (freeKickFor !== "ai") return;
        let successChance = 0.15;
        if (Math.random() < successChance) {
          startShotAnimation("ai", true);
        } else {
          startShotAnimation("ai", false);
        }
        freeKickFor = null;
      }, 1500);
      return;
    }

    // AI is ALWAYS aggressive:
    if (player.hasBall) {
      // Chase player to steal/tackle aggressively
      let dx = player.x - ai.x;
      let dy = player.y - ai.y;
      let distToPlayer = Math.hypot(dx, dy);

      if (distToPlayer > 10) {
        ai.x += (dx / distToPlayer) * ai.speed;
        ai.y += (dy / distToPlayer) * ai.speed;
      }

      if (distToPlayer < ai.size) {
        // Aggressive steal or tackle chance
        if (Math.random() < 0.3) {
          ai.hasBall = true;
          player.hasBall = false;
          ball.holder = "ai";
          showMessage("AI stole the ball!");
        } else if (Math.random() < 0.25) {
          freeKickFor = "player";
          showMessage("🟥 Free kick awarded to player ♦️");
          ai.hasBall = false;
          ball.holder = null;
        }
      }
    } else if (ai.hasBall) {
      if (!ai.shootDecisionMade) {
        ai.shootDecisionMade = true;
        if (Math.random() < 0.75) {
          // AI shoots immediately 75% of time
          let successChance = 0.15;
          if (Math.random() < successChance) {
            startShotAnimation("ai", true);
          } else {
            startShotAnimation("ai", false);
          }
          ai.hasBall = false;
          ball.holder = null;
          return;
        } else {
          ai.dribbling = true;
        }
      }
      if (ai.dribbling) {
        const goalX = 0;
        const goalY = ch / 2;
        let dx = goalX - ai.x;
        let dy = goalY - ai.y;
        let distToGoal = Math.hypot(dx, dy);

        if (distToGoal > 10) {
          ai.x += (dx / distToGoal) * ai.speed;
          ai.y += (dy / distToGoal) * ai.speed;
        }

        if (ai.x < 20 && Math.abs(ai.y - ch / 2) < ch * 0.2 / 2) {
          // Close to goal try shooting with 15% chance success
          if (Math.random() < 0.15) {
            startShotAnimation("ai", true);
          } else {
            startShotAnimation("ai", false);
          }
          ai.hasBall = false;
          ball.holder = null;
          ai.dribbling = false;
          ai.shootDecisionMade = false;
        }
      }
    } else {
      // If no one has ball, move toward ball
      let dx = ball.x - ai.x;
      let dy = ball.y - ai.y;
      let distToBall = Math.hypot(dx, dy);

      if (distToBall > 5) {
        ai.x += (dx / distToBall) * ai.speed;
        ai.y += (dy / distToBall) * ai.speed;
      }
    }
  }

  function checkPossession() {
    if (ball.holder) return; // Someone holds ball

    // Check player pickup ball
    if (dist(player, ball) < player.size / 1.5) {
      player.hasBall = true;
      ball.holder = "player";
    } else if (dist(ai, ball) < ai.size / 1.5) {
      ai.hasBall = true;
      ball.holder = "ai";
    }
  }

  function checkGoals() {
    const goalWidth = 10;
    const goalHeight = ch * 0.2;
    // Player goal (left)
    if (ball.x <= goalWidth && ball.y > ch / 2 - goalHeight / 2 && ball.y < ch / 2 + goalHeight / 2) {
      aiScore++;
      showMessage("Goal for AI!");
      resetPositions();
    }
    // AI goal (right)
    if (ball.x >= cw - goalWidth && ball.y > ch / 2 - goalHeight / 2 && ball.y < ch / 2 + goalHeight / 2) {
      playerScore++;
      showMessage("You scored!");
      resetPositions();
    }
  }

  function updateBall() {
    if (ball.holder === "player") {
      ball.x = player.x;
      ball.y = player.y + player.size / 2.7;
    } else if (ball.holder === "ai") {
      ball.x = ai.x;
      ball.y = ai.y + ai.size / 2.7;
    } else {
      ball.x += ball.dx;
      ball.y += ball.dy;
      ball.dx *= 0.95;
      ball.dy *= 0.95;
      // Keep ball inside canvas
      ball.x = Math.min(Math.max(ball.x, 0), cw);
      ball.y = Math.min(Math.max(ball.y, 0), ch);
    }
  }

  // Game timer & end
  function checkTimer() {
    let elapsed = (Date.now() - startTime) / 1000;
    if (elapsed >= gameDuration && !gameOver) {
      gameOver = true;
      let msg;
      if (playerScore > aiScore) msg = `You Win! Score: ${playerScore} - ${aiScore}`;
      else if (playerScore < aiScore) msg = `You Lost! Score: ${playerScore} - ${aiScore}`;
      else msg = `Draw! Score: ${playerScore} - ${aiScore}`;
      resultText.textContent = msg;
      messageBox.style.display = "block";
      controls.style.display = "none";
    }
  }

  function draw() {
    ctx.clearRect(0, 0, cw, ch);
    drawGoals();

    drawEntity(player, "🏃‍♂️‍➡️");
    drawEntity(ai, "🏃‍♂️");

    if (!ball.holder && !shotAnim) {
      ctx.font = `${ball.size}px serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("⚽️", ball.x, ball.y);
    }

    // Draw timer bar
    let elapsed = (Date.now() - startTime) / 1000;
    let timeLeft = Math.max(0, gameDuration - elapsed);
    const barWidth = cw * 0.5;
    const barHeight = 20;
    ctx.fillStyle = "#555";
    ctx.fillRect(cw / 2 - barWidth / 2, 10, barWidth, barHeight);
    ctx.fillStyle = "#f00";
    ctx.fillRect(cw / 2 - barWidth / 2, 10, (timeLeft / gameDuration) * barWidth, barHeight);
    ctx.strokeStyle = "white";
    ctx.strokeRect(cw / 2 - barWidth / 2, 10, barWidth, barHeight);

    // Scores
    ctx.fillStyle = "white";
    ctx.font = "24px Arial";
    ctx.textAlign = "left";
    ctx.fillText(`You: ${playerScore}`, 20, 40);
    ctx.textAlign = "right";
    ctx.fillText(`AI: ${aiScore}`, cw - 20, 40);

    // Shot animation
    if (shotAnim) {
      shotAnim.progress++;
      const progressRatio = shotAnim.progress / shotAnim.duration;
      ball.x = shotAnim.x + (shotAnim.targetX - shotAnim.x) * progressRatio;
      ball.y = shotAnim.y + (shotAnim.targetY - shotAnim.y) * progressRatio;
      if (shotAnim.progress >= shotAnim.duration) {
        shotAnim = null;
      }
    }
  }

  function update() {
    if (!gameOver) {
      if (!shootActive && !freeKickFor && !shotAnim) {
        checkPossession();
        updateBall();
        aiLogic();
        checkGoals();
      }
      checkTimer();
      draw();
      requestAnimationFrame(update);
    }
  }

  playBtn.onclick = () => {
    homeScreen.style.display = "none";
    canvas.style.display = "block";
    controls.style.display = "flex";
    init();
  };

  window.addEventListener("resize", () => {
    if (!gameOver) init();
  });

  // Start game loop on load to handle home screen display
  draw();

</script>
</body>
</html>
