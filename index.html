<!DOCTYPE html>
<html>
<head>
  <title>Responsive Soccer Game - Free Kicks & No Reset</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden; touch-action: none;
      background: green;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      background: #4CAF50;
    }
    #messageBox {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      display: none;
      z-index: 10;
    }
    #homeButton {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: white;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #controls {
      position: absolute;
      bottom: 10px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 10px;
      z-index: 5;
    }
    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: white;
      color: black;
      cursor: pointer;
      user-select: none;
    }
    #shootSliderContainer {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 30px;
      background: gray;
      border-radius: 15px;
      display: none;
      user-select: none;
    }
    #redZone {
      position: absolute;
      top: 0;
      height: 30px;
      background: red;
      border-radius: 15px;
      left: 40%;
      width: 20%;
    }
    #sliderArrow {
      position: absolute;
      top: -5px;
      width: 10px;
      height: 40px;
      background: yellow;
      border-radius: 3px;
      left: 0;
      transition: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="messageBox">
    <div id="resultText"></div>
    <button id="homeButton">Home</button>
  </div>
  <div id="controls">
    <button id="stealBtn" class="btn">Steal</button>
    <button id="tackleBtn" class="btn">Tackle</button>
    <button id="shootBtn" class="btn">Shoot</button>
  </div>
  <div id="shootSliderContainer">
    <div id="redZone"></div>
    <div id="sliderArrow"></div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let cw = window.innerWidth;
    let ch = window.innerHeight;
    canvas.width = cw;
    canvas.height = ch;

    // Sizes
    const baseSize = Math.min(cw, ch);
    const playerSize = baseSize * 0.05 * 3; // 3x bigger players
    const ballSize = playerSize * 0.3;

    // Entities
    let player = { x: cw * 0.1, y: ch / 2, size: playerSize, speed: 0.4 / 5, hasBall: false };
    let ai = { x: cw * 0.9, y: ch / 2, size: playerSize, speed: 0.4 * 2.3, hasBall: false };
    let ball = { x: cw / 2, y: ch / 2, size: ballSize, holder: null, dx: 0, dy: 0 };

    // Scores and timers
    let playerScore = 0;
    let aiScore = 0;
    let gameDuration = 60; // 1 minute
    let startTime = Date.now();
    let gameOver = false;

    // Message box
    const messageBox = document.getElementById("messageBox");
    const resultText = document.getElementById("resultText");
    const homeButton = document.getElementById("homeButton");
    homeButton.onclick = () => location.reload();

    // Controls
    const stealBtn = document.getElementById("stealBtn");
    const tackleBtn = document.getElementById("tackleBtn");
    const shootBtn = document.getElementById("shootBtn");
    const shootSliderContainer = document.getElementById("shootSliderContainer");
    const redZone = document.getElementById("redZone");
    const sliderArrow = document.getElementById("sliderArrow");

    // Goals
    const goalWidth = 10;
    const goalHeight = ch * 0.2;

    // Shoot slider variables
    let shootActive = false;
    let shootArrowPos = 0;
    let shootDirection = 1;
    let shootResultCallback = null;

    // Free kick state
    let freeKickFor = null; // "player" or "ai" or null

    function showMessage(msg) {
      resultText.textContent = msg;
      messageBox.style.display = "block";
      setTimeout(() => {
        if (!gameOver) messageBox.style.display = "none";
      }, 2500);
    }

    // Distance helper
    function dist(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    // Reset ball to midfield only (no full reset)
    function resetBallMidfield() {
      ball.x = cw / 2;
      ball.y = ch / 2;
      ball.dx = 0;
      ball.dy = 0;
      ball.holder = null;
      player.hasBall = false;
      ai.hasBall = false;
    }

    // Draw functions
    function drawEntity(entity, emoji) {
      ctx.font = `${entity.size}px serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(emoji, entity.x, entity.y);
      if (entity.hasBall) {
        // Draw ball just above entity
        ctx.font = `${ball.size}px serif`;
        ctx.fillText("⚽️", entity.x + entity.size / 2, entity.y - entity.size / 2);
      }
    }

    function drawGoals() {
      ctx.fillStyle = "white";
      // Left goal
      ctx.fillRect(0, ch / 2 - goalHeight / 2, goalWidth, goalHeight);
      // Right goal
      ctx.fillRect(cw - goalWidth, ch / 2 - goalHeight / 2, goalWidth, goalHeight);
    }

    // Player touch drag control, slowed 5x
    canvas.addEventListener("touchmove", (e) => {
      if (gameOver || shootActive) return;
      const touch = e.touches[0];
      if (!touch) return;
      if (!player.hasBall) {
        // Move player smoothly with slowdown (5x)
        let dx = (touch.clientX - player.x) * 0.2;
        let dy = (touch.clientY - player.y) * 0.2;
        player.x += dx;
        player.y += dy;
      } else {
        // If player has ball, allow normal drag so player can "carry" ball
        player.x = touch.clientX;
        player.y = touch.clientY;
      }
      e.preventDefault();
    }, { passive: false });

    // Steal button logic: 10% chance to steal if AI has ball
    stealBtn.onclick = () => {
      if (ai.hasBall && !player.hasBall && !shootActive) {
        if (Math.random() < 0.1) {
          ai.hasBall = false;
          player.hasBall = true;
          ball.holder = "player";
          showMessage("Steal successful!");
        } else {
          showMessage("Steal failed!");
        }
      }
    };

    // Tackle button logic: free kick to player if AI tackled, free kick to AI if player tackled
    tackleBtn.onclick = () => {
      if (shootActive || gameOver) return;

      if (ai.hasBall && !player.hasBall) {
        // AI tackled player, free kick for player
        freeKickFor = "player";
        showMessage("🟥 Free kick awarded to player ♦️");
        ai.hasBall = false;
        ball.holder = null;
      } else if (player.hasBall && !ai.hasBall) {
        // Player tackled AI, free kick for AI
        freeKickFor = "ai";
        showMessage("🟥 Free kick awarded to AI ♦️");
        player.hasBall = false;
        ball.holder = null;
      }
    };

    // Shoot button logic: start shoot slider if player has ball or free kick for player
    shootBtn.onclick = () => {
      if ((player.hasBall || freeKickFor === "player") && !shootActive) {
        startShootSlider((success) => {
          shootActive = false;
          shootSliderContainer.style.display = "none";

          if (freeKickFor === "player") {
            // Free kick shot from wherever ball is
            if (success) {
              if (Math.random() < 0.5) {
                playerScore++;
                showMessage("You scored from free kick!");
                resetBallMidfield();
              } else {
                showMessage("Free kick missed!");
              }
            } else {
              if (Math.random() < 0.1) {
                playerScore++;
                showMessage("Lucky free kick scored!");
                resetBallMidfield();
              } else {
                showMessage("Free kick missed!");
              }
            }
            freeKickFor = null;
            player.hasBall = false;
            ball.holder = null;
            return;
          }

          // Normal shot from possession
          if (success) {
            if (Math.random() < 0.5) {
              playerScore++;
              showMessage("You scored!");
              resetBallMidfield();
            } else {
              showMessage("Shot missed!");
            }
          } else {
            if (Math.random() < 0.1) {
              playerScore++;
              showMessage("Lucky shot scored!");
              resetBallMidfield();
            } else {
              showMessage("Shot missed!");
            }
          }
          player.hasBall = false;
          ball.holder = null;
        });
      }
    };

    // Shoot slider implementation
    function startShootSlider(callback) {
      shootActive = true;
      shootSliderContainer.style.display = "block";
      shootArrowPos = 0;
      shootDirection = 1;
      shootResultCallback = callback;

      function animate() {
        if (!shootActive) return;
        shootArrowPos += shootDirection * 5;
        if (shootArrowPos > 290) shootDirection = -1;
        else if (shootArrowPos < 0) shootDirection = 1;
        sliderArrow.style.left = shootArrowPos + "px";
        requestAnimationFrame(animate);
      }
      animate();
    }

    // Detect tap on shoot slider to "release" shot
    shootSliderContainer.addEventListener("click", () => {
      if (!shootActive) return;
      // Check if arrow is inside red zone (40% to 60% of container width)
      const redStart = shootSliderContainer.offsetWidth * 0.4;
      const redEnd = shootSliderContainer.offsetWidth * 0.6;
      const inRedZone = shootArrowPos >= redStart && shootArrowPos <= redEnd;
      shootActive = false;
      shootSliderContainer.style.display = "none";
      if (shootResultCallback) shootResultCallback(inRedZone);
    });

    // AI logic: 2.3x faster, smarter, with free kicks
    function aiLogic() {
      if (gameOver || shootActive) return;

      if (freeKickFor === "ai") {
        // AI free kick: auto shoot from current ball position after a delay
        setTimeout(() => {
          if (freeKickFor !== "ai") return; // might have changed
          if (Math.random() < 0.3) {
            aiScore++;
            showMessage("AI scored from free kick!");
          } else {
            showMessage("AI missed free kick!");
          }
          resetBallMidfield();
          freeKickFor = null;
        }, 1500);
        return;
      }

      if (player.hasBall) {
        // AI moves toward player to defend
        let dx = player.x - ai.x;
        let dy = player.y - ai.y;
        let distToPlayer = Math.hypot(dx, dy);

        if (distToPlayer > 10) {
          ai.x += (dx / distToPlayer) * ai.speed;
          ai.y += (dy / distToPlayer) * ai.speed;
        }

        // Try to steal or tackle
        if (distToPlayer < ai.size) {
          if (Math.random() < 0.15) { // steal chance
            ai.hasBall = true;
            player.hasBall = false;
            ball.holder = "ai";
            showMessage("AI stole the ball!");
          } else if (Math.random() < 0.15) { // tackle chance
            freeKickFor = "player";
            showMessage("🟥 Free kick awarded to player ♦️");
            ai.hasBall = false;
            ball.holder = null;
          }
        }
      } else if (ai.hasBall) {
        // AI tries to go toward player goal to score
        const goalX = 0;
        const goalY = ch / 2;
        let dx = goalX - ai.x;
        let dy = goalY - ai.y;
        let distToGoal = Math.hypot(dx, dy);

        if (distToGoal > 10) {
          ai.x += (dx / distToGoal) * ai.speed;
          ai.y += (dy / distToGoal) * ai.speed;
        }

        // AI shooting chance near goal
        if (ai.x < goalWidth + 10 &&
            Math.abs(ai.y - goalY) < goalHeight / 2 &&
            !shootActive) {
          // AI shoots with 30% success
          if (Math.random() < 0.3) {
            aiScore++;
            showMessage("AI scored!");
            resetBallMidfield();
          } else {
            showMessage("AI missed!");
          }
          ai.hasBall = false;
          ball.holder = null;
        }
      } else {
        // AI moves toward ball if loose
        let dx = ball.x - ai.x;
        let dy = ball.y - ai.y;
        let distToBall = Math.hypot(dx, dy);

        if (distToBall > 10) {
          ai.x += (dx / distToBall) * ai.speed;
          ai.y += (dy / distToBall) * ai.speed;
        }
      }
    }

    // Update ball position
    function updateBall() {
      if (player.hasBall) {
        ball.x = player.x + player.size * 0.3;
        ball.y = player.y;
        ball.holder = "player";
      } else if (ai.hasBall) {
        ball.x = ai.x - ai.size * 0.3;
        ball.y = ai.y;
        ball.holder = "ai";
      } else {
        ball.x += ball.dx;
        ball.y += ball.dy;
        // friction
        ball.dx *= 0.9;
        ball.dy *= 0.9;
        // stay in bounds
        if (ball.x < 0) ball.x = 0;
        if (ball.x > cw) ball.x = cw;
        if (ball.y < 0) ball.y = 0;
        if (ball.y > ch) ball.y = ch;
      }
    }

    // Check ball possession collisions
    function checkPossession() {
      if (!player.hasBall && !ai.hasBall && !freeKickFor) {
        if (dist(player, ball) < player.size) {
          player.hasBall = true;
          ball.holder = "player";
          ai.hasBall = false;
        } else if (dist(ai, ball) < ai.size) {
          ai.hasBall = true;
          ball.holder = "ai";
          player.hasBall = false;
        }
      }
    }

    // Check goal scoring - only AI can score by reaching goal line; player scores by shooting
    function checkGoals() {
      if (ball.holder === "ai" &&
          ball.x < goalWidth &&
          ball.y > ch / 2 - goalHeight / 2 &&
          ball.y < ch / 2 + goalHeight / 2) {
        aiScore++;
        showMessage("AI scored!");
        resetBallMidfield();
      }
    }

    // Timer and game end
    function checkTimer() {
      let elapsed = (Date.now() - startTime) / 1000;
      if (elapsed >= gameDuration) {
        gameOver = true;
        let msg = "";
        if (playerScore > aiScore) msg = `You Win! Score: ${playerScore} - ${aiScore}`;
        else if (playerScore < aiScore) msg = `You Lost! Score: ${playerScore} - ${aiScore}`;
        else msg = `Draw! Score: ${playerScore} - ${aiScore}`;
        messageBox.style.display = "block";
        resultText.textContent = msg;
      }
    }

    // Draw everything
    function draw() {
      ctx.clearRect(0, 0, cw, ch);
      drawGoals();

      // Draw ball on field if no holder
      if (!ball.holder) {
        ctx.font = `${ball.size}px serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("⚽️", ball.x, ball.y);
      }

      // Draw players with ball indicator
      drawEntity(player, "🏃‍♂️‍➡️");
      drawEntity(ai, "🏃‍♂️");

      // Draw scores and timer
      ctx.fillStyle = "white";
      ctx.font = "24px Arial";
      ctx.textAlign = "left";
      ctx.fillText(`You: ${playerScore}`, 20, 40);
      ctx.textAlign = "right";
      ctx.fillText(`AI: ${aiScore}`, cw - 20, 40);

      // Timer bar
      let elapsed = (Date.now() - startTime) / 1000;
      let timeLeft = Math.max(0, gameDuration - elapsed);
      const barWidth = cw * 0.5;
      const barHeight = 20;
      ctx.fillStyle = "#555";
      ctx.fillRect(cw / 2 - barWidth / 2, 10, barWidth, barHeight);
      ctx.fillStyle = "#f00";
      ctx.fillRect(cw / 2 - barWidth / 2, 10, (timeLeft / gameDuration) * barWidth, barHeight);
      ctx.strokeStyle = "white";
      ctx.strokeRect(cw / 2 - barWidth / 2, 10, barWidth, barHeight);
    }

    // Main update loop
    function update() {
      if (gameOver) return;

      if (!shootActive) {
        checkPossession();
        updateBall();
        aiLogic();
        checkGoals();
      }
      checkTimer();
      draw();

      requestAnimationFrame(update);
    }

    update();
  </script>
</body>
</html>
